apiVersion: v1
kind: ConfigMap
metadata:
  name: db-migrations
  labels:
    app: youngth-guard-backend
    component: migration
    managed-by: argocd
data:
  # ============================================
  # 迁移文件示例
  # ============================================
  # 实际项目中，建议：
  # 1. 将迁移文件打包到应用镜像中
  # 2. 或使用 initContainer 从 Git 拉取
  # 3. 这里仅作为示例
  # ============================================

  V1__initial_schema.sql: |
    -- ============================================
    -- Migration: V1__initial_schema
    -- Description: 初始化数据库 Schema
    -- ============================================

    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(50) NOT NULL UNIQUE,
        email VARCHAR(255) NOT NULL UNIQUE,
        created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);

    CREATE TABLE IF NOT EXISTS assessments (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
        status VARCHAR(20) NOT NULL DEFAULT 'pending',
        created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_assessments_user_id ON assessments(user_id);
    CREATE INDEX IF NOT EXISTS idx_assessments_status ON assessments(status);

    COMMENT ON TABLE users IS '用户表';
    COMMENT ON TABLE assessments IS '心理评估记录表';

  V2__add_phone_column.sql: |
    -- ============================================
    -- Migration: V2__add_phone_column
    -- Description: 添加手机号列
    -- ============================================

    ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);
    CREATE INDEX IF NOT EXISTS idx_users_phone ON users(phone) WHERE phone IS NOT NULL;
    COMMENT ON COLUMN users.phone IS '用户手机号（可选）';
