# 平台目标架构说明

## 📋 概述

本平台采用 **GitOps + 基础设施复用** 的架构模式，实现应用的自动化发布和统一的数据库管理。

---

## 🔄 CI/CD 职责边界

### GitHub Actions（CI 层）
**职责：构建和推送**
- 代码提交后自动触发
- 构建 Docker 镜像
- 推送镜像到容器仓库（GHCR）
- 更新 GitOps 仓库的镜像版本

**不负责：** 实际部署、数据库管理、环境配置

### ArgoCD（CD 层）
**职责：部署和同步**
- 监听 GitOps 仓库变化
- 自动将声明式配置同步到 Kubernetes
- 执行数据库迁移（PreSync Hook）
- 保证集群状态与 Git 一致

**不负责：** 构建镜像、修改代码

---

## 🏃 GitHub Runner 定位

### 默认：GitHub Hosted Runner
**适用场景：** 所有标准构建任务
- 无需维护
- 按使用付费
- 适合 95% 的场景

### ARC (Actions Runner Controller)
**仅在以下场景启用：**
- 需要访问内网资源
- 构建时间超过 6 小时
- 需要 GPU 等特殊硬件

**原则：** 不使用则不部署，避免维护成本

---

## 🗄️ Infra Postgres 角色

### 定位：平台级共享数据库服务
**为什么不是每个项目独立部署？**
- 减少资源浪费（内存、存储）
- 统一备份和恢复策略
- 集中监控和运维

### 使用方式
```
一个 Postgres 实例 → 多个独立数据库
├── youngth_guard_dev      （项目1 - 开发环境）
├── youngth_guard_prod     （项目1 - 生产环境）
├── other_project_dev      （项目2 - 开发环境）
└── ...
```

### 隔离保证
- **数据库级别隔离**：每个项目有独立的数据库和用户
- **权限最小化**：应用用户只能访问自己的数据库
- **网络隔离**：仅集群内访问，不对外暴露

---

## 🔗 应用、数据库、迁移、回滚关系

### 正常发布流程
```
1. 开发者 git push
   ↓
2. GitHub Actions 构建镜像
   ↓
3. 更新 GitOps 仓库
   ↓
4. ArgoCD 检测到变化
   ↓
5. 执行数据库迁移（PreSync Hook）
   ✓ 成功 → 继续部署应用
   ✗ 失败 → 阻止部署
   ↓
6. 部署新版本应用
```

### 回滚策略

#### 应用回滚（快速）
- **方式：** Git revert → ArgoCD 自动回滚
- **时间：** 2-5 分钟
- **场景：** 应用逻辑问题、性能问题

#### 数据库回滚（谨慎）
- **方式 1：** 兼容性迁移（推荐）
  - 新旧版本共存的 Schema 设计
  - 不需要真正回滚

- **方式 2：** PITR（Point-In-Time Recovery）
  - 恢复到指定时间点
  - 用于严重数据错误
  - **注意：** 会丢失恢复点之后的数据

---

## ✅ 核心原则

1. **不中断服务**
   - 数据库迁移必须向后兼容
   - 应用先部署新版本，再清理旧 Schema

2. **可回滚**
   - 应用随时可以回到上一个版本
   - 数据库设计支持新旧版本共存

3. **自动化优先**
   - 减少人工操作
   - 所有变更通过 Git 触发

4. **基础设施复用**
   - 共享 Postgres、监控、日志
   - 降低运维复杂度

---

## 🎯 对团队的意义

**对开发者：**
- 只需要 `git push`，无需关心部署细节
- 数据库自动创建和迁移
- 专注业务逻辑开发

**对运维：**
- 统一的备份和恢复流程
- 集中监控和告警
- 减少重复劳动

**对业务：**
- 更快的发布速度
- 更高的系统稳定性
- 更低的运维成本
