apiVersion: batch/v1
kind: CronJob
metadata:
  name: deploy-promoter
  namespace: shared-platform
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: promoter
              image: alpine:3.20
              imagePullPolicy: IfNotPresent
              env:
                - name: DEPLOY_REPO_URL
                  value: https://github.com/BrunoGaoSZ/ljwx-deploy.git
                - name: RETRY_MAX
                  value: "10"
                - name: DRY_RUN
                  value: "0"
                - name: HARBOR_URL
                  value: https://harbor.omniverseai.net
                - name: DEPLOY_REPO_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: promoter-secrets
                      key: DEPLOY_REPO_TOKEN
                - name: HARBOR_USER
                  valueFrom:
                    secretKeyRef:
                      name: promoter-secrets
                      key: HARBOR_USER
                - name: HARBOR_PASS
                  valueFrom:
                    secretKeyRef:
                      name: promoter-secrets
                      key: HARBOR_PASS
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  apk add --no-cache bash git curl python3 py3-pip
                  pip install --break-system-packages --no-cache-dir pyyaml jsonschema
                  rm -rf /work/repo
                  git clone "https://x-access-token:${DEPLOY_REPO_TOKEN}@github.com/BrunoGaoSZ/ljwx-deploy.git" /work/repo
                  cd /work/repo
                  export LOCAL_REPO_DIR=/work/repo
                  bash scripts/promoter/promote.sh
